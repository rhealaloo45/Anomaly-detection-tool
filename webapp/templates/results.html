<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .anomaly-card { transition: transform 0.2s; }
        .anomaly-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-5">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Log Anomaly Detector</a>
        <a href="/" class="btn btn-outline-light btn-sm">New Analysis</a>
    </div>
</nav>

<div class="container mb-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold">Analysis Report: <span class="text-primary">{{ filename }}</span></h2>
    </div>

    <div class="row g-4">
        <!-- Autoencoder Results -->
        <div class="col-lg-6">
            <div class="card h-100 shadow border-0">
                <div class="card-header border-bottom-0 pt-4 px-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="card-title fw-bold mb-0">Autoencoder Model</h4>
                        <span class="badge bg-danger rounded-pill fs-6">{{ results.autoencoder.count }} Anomalies</span>
                    </div>
                </div>
                <div class="card-body px-4 pb-4">
                    <p class="text-muted small">Deep learning model trained to reconstruct normal patterns. High reconstruction error indicates an anomaly.</p>
                    
                    {% if results.autoencoder.anomalies %}
                    <h6 class="fw-bold mt-4 mb-3 text-secondary">Top Anomalies Explained</h6>
                    <div class="accordion" id="accordionAE">
                        {% for item in results.autoencoder.anomalies %}
                        <div class="accordion-item border-0 mb-3 shadow-sm rounded overflow-hidden">
                            <h2 class="accordion-header" id="headingAE{{ loop.index }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAE{{ loop.index }}" aria-expanded="false">
                                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                        <span class="fw-bold text-danger">#{{ item.index }}</span>
                                        <small class="text-muted ms-2">Error: {{ "%.4f"|format(item.error) }}</small>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapseAE{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAE">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <strong>Log:</strong> <code class="border rounded px-2 py-1">{{ item.log.request }}</code>
                                    </div>
                                    <div class="mb-3">
                                        <span class="badge bg-secondary">Status: {{ item.log.status }}</span>
                                        <span class="badge bg-secondary">Bytes: {{ item.log.bytes }}</span>
                                    </div>
                                    <div class="alert alert-warning border-warning d-flex align-items-start">
                                        <i class="bi bi-lightbulb-fill me-2 mt-1"></i>
                                        <div>
                                            <strong>AI Explanation:</strong> {{ item.explanation }}
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 class="small text-muted mb-2">Feature Contribution</h6>
                                        <div style="height: 200px; width: 100%;">
                                            <canvas id="chartAE{{ loop.index }}"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">No significant anomalies detected.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Isolation Forest Results -->
        <div class="col-lg-6">
            <div class="card h-100 shadow border-0">
                <div class="card-header border-bottom-0 pt-4 px-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h4 class="card-title fw-bold mb-0">Isolation Forest</h4>
                        <span class="badge bg-danger rounded-pill fs-6">{{ results.isolation_forest.count }} Anomalies</span>
                    </div>
                </div>
                <div class="card-body px-4 pb-4">
                    <p class="text-muted small">Machine learning algorithm that isolates anomalies by randomly selecting a feature and split value.</p>
                    
                    {% if results.isolation_forest.anomalies %}
                    <h6 class="fw-bold mt-4 mb-3 text-secondary">Top Anomalies Explained</h6>
                    <div class="accordion" id="accordionIso">
                        {% for item in results.isolation_forest.anomalies %}
                        <div class="accordion-item border-0 mb-3 shadow-sm rounded overflow-hidden">
                            <h2 class="accordion-header" id="headingIso{{ loop.index }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIso{{ loop.index }}" aria-expanded="false">
                                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                        <span class="fw-bold text-danger">#{{ item.index }}</span>
                                        <small class="text-muted ms-2">Score: -1</small>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapseIso{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionIso">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <strong>Log:</strong> <code class="border rounded px-2 py-1">{{ item.log.request }}</code>
                                    </div>
                                    <div class="mb-3">
                                        <span class="badge bg-secondary">Status: {{ item.log.status }}</span>
                                        <span class="badge bg-secondary">Bytes: {{ item.log.bytes }}</span>
                                    </div>
                                    <div class="alert alert-warning border-warning d-flex align-items-start">
                                        <i class="bi bi-lightbulb-fill me-2 mt-1"></i>
                                        <div>
                                            <strong>AI Explanation:</strong> {{ item.explanation }}
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 class="small text-muted mb-2">Feature Contribution</h6>
                                        <div style="height: 200px; width: 100%;">
                                            <canvas id="chartIso{{ loop.index }}"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">No significant anomalies detected.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function renderChart(canvasId, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Contribution',
                    data: data.values,
                    backgroundColor: data.values.map(v => v < 0 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(75, 192, 192, 0.7)'),
                    borderColor: data.values.map(v => v < 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)'),
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        ticks: { color: '#8b949e' },
                        grid: { color: '#30363d' } 
                    },
                    y: { 
                        ticks: { color: '#8b949e' },
                        grid: { display: false } 
                    }
                }
            }
        });
    }

    // Render charts
    {% if results.autoencoder.anomalies %}
        {% for item in results.autoencoder.anomalies %}
            renderChart('chartAE{{ loop.index }}', {{ item.graph_data | tojson }});
        {% endfor %}
    {% endif %}

    {% if results.isolation_forest.anomalies %}
        {% for item in results.isolation_forest.anomalies %}
            renderChart('chartIso{{ loop.index }}', {{ item.graph_data | tojson }});
        {% endfor %}
    {% endif %}
</script>
</body>
</html>